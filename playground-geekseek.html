<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geekseek Playground</title>
    <style>
      :root {
        --bg: #0f1220;
        --panel: #171b2f;
        --panel-soft: #1f2441;
        --text: #e6eaf2;
        --muted: #98a0bd;
        --accent: #7aa2f7;
        --accent-soft: rgba(122, 162, 247, 0.18);
        --ok: #38d39f;
        --warn: #f7c948;
        --err: #ff6b6b;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, rgba(122, 162, 247, 0.18), transparent 50%), var(--bg);
        color: var(--text);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 32px 16px 80px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 26px;
      }
      p.lead {
        margin: 0 0 20px;
        color: var(--muted);
      }
      .panel {
        background: var(--panel);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 20px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.4);
        margin-bottom: 20px;
      }
      .tab-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .tab-bar button {
        flex: 1 1 130px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: var(--panel-soft);
        color: var(--muted);
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .tab-bar button.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--text);
      }
      .mode-panel {
        display: none;
        flex-direction: column;
        gap: 14px;
      }
      .mode-panel.active {
        display: flex;
      }
      label {
        font-size: 12px;
        letter-spacing: 0.08em;
        color: var(--muted);
        text-transform: uppercase;
        display: block;
        margin-bottom: 6px;
      }
      textarea,
      input {
        width: 100%;
        border-radius: 13px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: #0d1122;
        color: var(--text);
        padding: 12px;
        font-size: 14px;
        outline: none;
      }
      textarea {
        min-height: 96px;
        resize: vertical;
      }
      .primary {
        border: none;
        border-radius: 12px;
        background: var(--accent);
        color: #060916;
        font-weight: 700;
        padding: 12px;
        cursor: pointer;
      }
      .primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .note {
        font-size: 12px;
        color: var(--muted);
      }
      .results-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .status {
        font-size: 13px;
        color: var(--muted);
      }
      .status.ok {
        color: var(--ok);
      }
      .status.warn {
        color: var(--warn);
      }
      .status.err {
        color: var(--err);
      }
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px;
        margin-top: 16px;
      }
      .card-entry {
        background: var(--panel-soft);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 14px;
      }
      .card-entry h3 {
        margin: 0 0 6px;
        font-size: 16px;
      }
      .card-entry .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .comparison-mode {
        display: block;
      }
      table.compare {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      table.compare th,
      table.compare td {
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 8px;
        text-align: left;
      }
      table.compare th {
        background: rgba(255, 255, 255, 0.05);
      }
      .links {
        display: grid;
        gap: 6px;
        margin-top: 12px;
      }
      .links a {
        color: var(--accent);
        text-decoration: none;
        font-size: 13px;
      }
      pre#rawOut {
        margin-top: 16px;
        border-radius: 12px;
        background: #0b0f1d;
        color: #b5bedc;
        padding: 12px;
        font-size: 12px;
        max-height: 320px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Geekseek Playground</h1>
      <p class="lead">Run location searches or request comparison tables from the unified Geekseek API.</p>

      <div class="panel">
        <div class="tab-bar">
          <button type="button" class="active" data-mode-tab="places">Places</button>
          <button type="button" data-mode-tab="compare">Compare</button>
        </div>

        <form id="form-places" class="mode-panel active" autocomplete="off">
          <div>
            <label for="placesQuery">Places prompt</label>
            <textarea
              id="placesQuery"
              placeholder="Example: Find quiet coffee shops with Wi-Fi near Berlin that open late"
              required
            ></textarea>
            <div class="note">Describe everything in one prompt (location, filters, vibe, price, etc.).</div>
          </div>
          <button type="submit" class="primary">Search Places</button>
        </form>

        <form id="form-compare" class="mode-panel" autocomplete="off">
          <div>
            <label for="compareQuery">Comparison prompt</label>
            <textarea
              id="compareQuery"
              placeholder="Example: Compare iPhone 15 Pro vs Galaxy S24 Ultra hardware stats and camera quality"
              required
            ></textarea>
            <div class="note">Include the items and factors you care about directly in this prompt.</div>
          </div>
          <button type="submit" class="primary">Compare</button>
        </form>
      </div>

      <div class="panel">
        <div class="results-header">
          <strong>Results</strong>
          <span id="status" class="status">idle</span>
        </div>
        <div id="cards" class="cards"></div>
        <pre id="rawOut"></pre>
      </div>
    </div>

    <script>
      const API_URL = "/api/geekseek";
      const tabs = document.querySelectorAll("[data-mode-tab]");
      const panels = document.querySelectorAll(".mode-panel");
      const statusEl = document.getElementById("status");
      const cardsEl = document.getElementById("cards");
      const rawEl = document.getElementById("rawOut");
      const state = { mode: "places", coords: null };
      const NEAR_ME_REGEX = /\b(near\s*me|around\s*me|around\s*here|nearby|close\s*to\s*me)\b/i;

      tabs.forEach((btn) => {
        btn.addEventListener("click", () => setMode(btn.dataset.modeTab));
      });

      function setMode(mode) {
        state.mode = mode;
        tabs.forEach((btn) => btn.classList.toggle("active", btn.dataset.modeTab === mode));
        panels.forEach((panel) => panel.classList.toggle("active", panel.id === panelId(mode)));
        resetResults("idle");
      }

      function panelId(mode) {
        return mode === "compare" ? "form-compare" : "form-places";
      }

      function setStatus(text, tone = "") {
        statusEl.textContent = text;
        statusEl.className = `status ${tone}`.trim();
      }

      function resetResults(message = "idle") {
        setStatus(message);
        cardsEl.innerHTML = "";
        cardsEl.classList.remove("comparison-mode");
        rawEl.textContent = "";
      }

      document.getElementById("form-places").addEventListener("submit", async (event) => {
        event.preventDefault();
        await runPlacesSearch();
      });

      document.getElementById("form-compare").addEventListener("submit", async (event) => {
        event.preventDefault();
        await runCompareSearch();
      });

      async function requestGeolocation() {
        if (!navigator.geolocation) {
          setStatus("Geolocation not supported in this browser", "err");
          return null;
        }
        setStatus("Requesting your location…", "warn");
        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const coords = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
              state.coords = coords;
              setStatus("Location acquired", "ok");
              resolve(coords);
            },
            (error) => {
              console.error(error);
              setStatus(error.message ?? "Unable to fetch location", "err");
              resolve(null);
            },
            { enableHighAccuracy: false, maximumAge: 120000, timeout: 8000 }
          );
        });
      }

      async function runPlacesSearch() {
        const query = document.getElementById("placesQuery").value.trim();
        if (!query) return setStatus("Enter a query", "err");
        const needsGeo = NEAR_ME_REGEX.test(query);
        let coords = null;
        if (needsGeo) {
          coords = await requestGeolocation();
        }
        const params = new URLSearchParams();
        params.set("type", "places");
        params.set("q", query);
        if (needsGeo && coords) {
          params.set("lat", coords.latitude);
          params.set("lng", coords.longitude);
        }

        resetResults("Sending places request...");
        try {
          const response = await fetch(`${API_URL}?${params.toString()}`, {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          rawEl.textContent = JSON.stringify(payload, null, 2);
          renderPlaces(payload.items || payload.results || []);
        } catch (error) {
          console.error(error);
          setStatus(error.message ?? "Request failed", "err");
        }
      }

      async function runCompareSearch() {
        const query = document.getElementById("compareQuery").value.trim();
        if (!query) return setStatus("Enter a prompt", "err");
        const params = new URLSearchParams();
        params.set("type", "compare");
        params.set("q", query);
        params.set("rows", "25");

        resetResults("Generating comparison...");
        try {
          const response = await fetch(`${API_URL}?${params.toString()}`, {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          rawEl.textContent = JSON.stringify(payload, null, 2);
          renderComparison(payload);
        } catch (error) {
          console.error(error);
          setStatus(error.message ?? "Request failed", "err");
        }
      }

      function renderPlaces(items) {
        cardsEl.classList.remove("comparison-mode");
        cardsEl.innerHTML = "";
        if (!Array.isArray(items) || !items.length) {
          setStatus("No places found", "warn");
          return;
        }
        setStatus(`${items.length} places`, "ok");
        items.slice(0, 12).forEach((place) => {
          const div = document.createElement("div");
          div.className = "card-entry";
          const href = place.googleMapsUri || place.websiteUri || "#";
          const rating =
            typeof place.rating === "number"
              ? `<div class="muted">⭐ ${place.rating.toFixed(1)} (${place.userRatingCount ?? 0})</div>`
              : "";
          div.innerHTML = `
            <h3>${place.name ?? "Untitled"}</h3>
            <div class="muted">${place.address ?? ""}</div>
            ${rating}
            ${
              href && href !== "#"
                ? `<a href="${href}" target="_blank" rel="noopener">Open map/site</a>`
                : ""
            }
          `;
          cardsEl.appendChild(div);
        });
      }

      function renderComparison(payload = {}) {
        cardsEl.classList.add("comparison-mode");
        cardsEl.innerHTML = "";
        const block = document.createElement("div");
        block.className = "card-entry";
        const items = Array.isArray(payload.items) ? payload.items : [];
        const pills = items
          .map((item) => `<span style="margin-right:8px;color:${items.length ? '#e6eaf2' : '#98a0bd'}">${item}</span>`)
          .join("");
        const tableHtml = payload.table?.html || payload.description || "<p class=\"muted\">No table returned.</p>";
        const highlights = Array.isArray(payload.highlights) ? payload.highlights : [];
        const links = Array.isArray(payload.links) ? payload.links : [];
        const highlightHtml = highlights
          .map(
            (entry) => `
              <div style="border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:10px;">
                <strong>${entry.item || "Highlight"}</strong>
                <div class="muted">${entry.summary || ""}</div>
              </div>
            `
          )
          .join("");
        const linksHtml = links
          .map((link) => `<a href="${link.url}" target="_blank" rel="noopener">${link.label || link.url}</a>`)
          .join("");

        block.innerHTML = `
          <div class="note" style="margin-bottom:8px;">${pills}</div>
          <div class="table-wrap">${tableHtml}</div>
          ${highlightHtml ? `<div style="margin-top:12px;display:grid;gap:10px;">${highlightHtml}</div>` : ""}
          ${payload.summary ? `<div style="margin-top:12px;">${payload.summary}</div>` : ""}
          ${linksHtml ? `<div class="links">${linksHtml}</div>` : ""}
        `;
        cardsEl.appendChild(block);
        setStatus("Comparison ready", "ok");
      }

      resetResults("idle");
    </script>
  </body>
</html>
